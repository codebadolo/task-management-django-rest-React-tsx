{% extends 'base.html' %}
{% load static %}

{% block title %}Kanban - Gestion de Projet{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* Variables */
    :root {
        --todo-color: #a0aec0;
        --in-progress-color: #4299e1;
        --review-color: #ed8936;
        --done-color: #48bb78;
        --blocked-color: #f56565;
        --bg-light: #f7fafc;
        --border-color: #e2e8f0;
    }

    /* Layout Kanban */
    .kanban-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        overflow-x: auto;
        min-height: calc(100vh - 120px);
        background: var(--bg-light);
    }

    /* Colonnes */
    .kanban-column {
        flex: 1;
        min-width: 300px;
        max-width: 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        height: fit-content;
        max-height: calc(100vh - 120px);
    }

    .column-header {
        padding: 16px;
        border-bottom: 2px solid;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }

    .column-todo .column-header { border-color: var(--todo-color); }
    .column-in_progress .column-header { border-color: var(--in-progress-color); }
    .column-review .column-header { border-color: var(--review-color); }
    .column-done .column-header { border-color: var(--done-color); }
    .column-blocked .column-header { border-color: var(--blocked-color); }

    .column-title {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .column-title i {
        font-size: 1.2em;
    }

    .task-count {
        background: var(--bg-light);
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.85em;
    }

    /* Liste des t√¢ches */
    .task-list {
        flex: 1;
        padding: 12px;
        min-height: 200px;
        overflow-y: auto;
        max-height: calc(100vh - 250px);
    }

    /* Cartes de t√¢ches */
    .task-card {
        background: white;
        border: 1px solid var(--border-color);
        border-left: 4px solid;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .task-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .priority-1 { border-left-color: var(--todo-color); }
    .priority-2 { border-left-color: #48bb78; }
    .priority-3 { border-left-color: var(--in-progress-color); }
    .priority-4 { border-left-color: var(--review-color); }
    .priority-5 { border-left-color: var(--blocked-color); }

    /* En-t√™te de carte */
    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .task-title {
        font-weight: 600;
        font-size: 14px;
        color: #2d3748;
        margin: 0;
        cursor: pointer;
    }

    .task-title:hover {
        color: var(--in-progress-color);
    }

    .task-priority {
        font-size: 16px;
        cursor: help;
    }

    /* M√©tadonn√©es */
    .task-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        font-size: 12px;
        color: #718096;
    }

    .task-assignees {
        display: flex;
        gap: 4px;
    }

    .assignee-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        color: white;
        cursor: help;
    }

    .due-date {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .due-date.urgent {
        color: var(--blocked-color);
        font-weight: 600;
    }

    .due-date.warning {
        color: var(--review-color);
    }

    /* Barre de progression */
    .task-progress {
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-bar {
        height: 100%;
        background: var(--done-color);
        transition: width 0.3s;
    }

    /* Badges */
    .badge-complexity {
        display: inline-flex;
        gap: 2px;
        font-size: 10px;
    }

    /* Bouton d'ajout */
    .add-task-btn {
        margin: 12px;
        padding: 10px;
        border: 2px dashed var(--border-color);
        border-radius: 6px;
        background: transparent;
        color: #718096;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 500;
    }

    .add-task-btn:hover {
        background: var(--bg-light);
        border-color: var(--in-progress-color);
        color: var(--in-progress-color);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-content {
        position: relative;
        width: 90%;
        max-width: 800px;
        margin: 50px auto;
        background: white;
        border-radius: 16px;
        padding: 24px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .modal-title {
        font-size: 1.5em;
        font-weight: 600;
        margin: 0;
    }

    .close-btn {
        font-size: 24px;
        cursor: pointer;
        color: #718096;
        transition: color 0.2s;
    }

    .close-btn:hover {
        color: var(--blocked-color);
    }

    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        padding: 4px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 4px;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 24px;
    }

    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        font-weight: 500;
        color: #718096;
        transition: all 0.2s;
    }

    .tab:hover {
        background: var(--bg-light);
        color: #2d3748;
    }

    .tab.active {
        color: var(--in-progress-color);
        border-bottom: 2px solid var(--in-progress-color);
        margin-bottom: -2px;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    /* Formulaires */
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #2d3748;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--in-progress-color);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    select.form-control {
        cursor: pointer;
    }

    /* Grille */
    .row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .col {
        flex: 1;
    }

    /* Commentaires */
    .comment {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .comment-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--in-progress-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        flex-shrink: 0;
    }

    .comment-content {
        flex: 1;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .comment-author {
        font-weight: 600;
        color: #2d3748;
    }

    .comment-date {
        font-size: 12px;
        color: #718096;
    }

    .comment-text {
        color: #4a5568;
        line-height: 1.5;
    }

    /* Pi√®ces jointes */
    .attachment {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-light);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .attachment-icon {
        font-size: 24px;
    }

    .attachment-info {
        flex: 1;
    }

    .attachment-name {
        font-weight: 500;
        color: #2d3748;
    }

    .attachment-meta {
        font-size: 12px;
        color: #718096;
    }

    .attachment-download {
        color: var(--in-progress-color);
        text-decoration: none;
        font-size: 20px;
    }

    /* S√©lecteur de projet */
    .project-selector {
        margin: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .project-select {
        padding: 10px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        min-width: 250px;
    }

    /* Statistiques */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-value {
        font-size: 2em;
        font-weight: 600;
        color: var(--in-progress-color);
    }

    .stat-label {
        color: #718096;
        font-size: 0.9em;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .kanban-container {
            flex-direction: column;
            padding: 10px;
        }
        
        .kanban-column {
            min-width: 100%;
        }
        
        .row {
            flex-direction: column;
        }
        
        .modal-content {
            width: 95%;
            margin: 20px auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="kanban-container">
    <!-- S√©lecteur de projet -->
    <div class="project-selector">
        <select class="project-select" id="project-select" onchange="changeProject(this.value)">
            <option value="">Tous les projets</option>
            {% for project in projects %}
            <option value="{{ project.id }}" {% if current_project.id == project.id %}selected{% endif %}>
                {{ project.name }} ({{ project.code }})
            </option>
            {% endfor %}
        </select>
        
        <button class="add-task-btn" style="display: inline-flex; width: auto;" onclick="openTaskModal(null)">
            <i class="fas fa-plus"></i> Nouvelle t√¢che
        </button>
    </div>
    
    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_taches }}</div>
            <div class="stat-label">Total t√¢ches</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.taches_terminees }}</div>
            <div class="stat-label">Termin√©es</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.taches_retard }}</div>
            <div class="stat-label">En retard</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.taches_aujourdhui }}</div>
            <div class="stat-label">√Ä faire aujourd'hui</div>
        </div>
    </div>
    
    <!-- Colonnes Kanban -->
    {% for status, tasks in kanban_columns.items %}
    <div class="kanban-column column-{{ status }}" data-status="{{ status }}">
        <div class="column-header">
            <div class="column-title">
                <i class="fas 
                    {% if status == 'todo' %}fa-clock
                    {% elif status == 'in_progress' %}fa-spinner
                    {% elif status == 'review' %}fa-search
                    {% elif status == 'done' %}fa-check-circle
                    {% elif status == 'blocked' %}fa-exclamation-circle
                    {% endif %}">
                </i>
                <span>
                    {% if status == 'todo' %}√Ä faire
                    {% elif status == 'in_progress' %}En cours
                    {% elif status == 'review' %}En revue
                    {% elif status == 'done' %}Termin√©
                    {% elif status == 'blocked' %}Bloqu√©
                    {% endif %}
                </span>
            </div>
            <span class="task-count">{{ tasks.count }}</span>
        </div>
        
        <div class="task-list" id="list-{{ status }}" data-status="{{ status }}">
            {% for task in tasks %}
            <div class="task-card priority-{{ task.priority }}" data-task-id="{{ task.id }}" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="openTaskModal({{ task.id }})">
                <div class="task-header">
                    <h4 class="task-title">{{ task.title|truncatechars:50 }}</h4>
                    <span class="task-priority" title="Priorit√©: {{ task.get_priority_display }}">
                        {% if task.priority == 1 %}‚¨áÔ∏è
                        {% elif task.priority == 2 %}‚û°Ô∏è
                        {% elif task.priority == 3 %}‚ûñ
                        {% elif task.priority == 4 %}‚¨ÜÔ∏è
                        {% elif task.priority == 5 %}‚ö†Ô∏è
                        {% endif %}
                    </span>
                </div>
                
                <div class="task-meta">
                    <div class="task-assignees">
                        {% for user in task.assigned_to.all|slice:":3" %}
                        <div class="assignee-avatar" style="background: hsl({{ user.id|stringformat:"s"|make_list|first|add:"20" }}, 70%, 60%);" title="{{ user.get_full_name }}">
                            {{ user.get_initials }}
                        </div>
                        {% endfor %}
                        {% if task.assigned_to.count > 3 %}
                        <div class="assignee-avatar" style="background: #718096;">+{{ task.assigned_to.count|add:"-3" }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="due-date {% if task.due_date < now and not task.is_completed %}urgent{% elif task.due_date < now|add:"3" %}warning{% endif %}">
                        <i class="far fa-calendar"></i>
                        {{ task.due_date|date:"d/m" }}
                    </div>
                </div>
                
                {% if task.completion_percentage > 0 %}
                <div class="task-progress">
                    <div class="progress-bar" style="width: {{ task.completion_percentage }}%;"></div>
                </div>
                {% endif %}
                
                <div class="badge-complexity">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= task.complexity %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <div class="empty-list" style="text-align: center; color: #a0aec0; padding: 20px;">
                <i class="fas fa-inbox" style="font-size: 2em; margin-bottom: 10px;"></i>
                <p>Aucune t√¢che</p>
            </div>
            {% endfor %}
        </div>
        
        <button class="add-task-btn" onclick="openTaskModal(null, '{{ status }}')">
            <i class="fas fa-plus"></i> Ajouter une t√¢che
        </button>
    </div>
    {% endfor %}
</div>

<!-- Modal D√©tail T√¢che -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">D√©tails de la t√¢che</h2>
            <span class="close-btn" onclick="closeTaskModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('details')">D√©tails</div>
                <div class="tab" onclick="switchTab('comments')">Commentaires</div>
                <div class="tab" onclick="switchTab('attachments')">Pi√®ces jointes</div>
                <div class="tab" onclick="switchTab('history')">Historique</div>
            </div>
            
            <!-- Tab D√©tails -->
            <div id="details-tab" class="tab-pane active">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <input type="hidden" id="taskId" name="task_id">
                    
                    <div class="form-group">
                        <label>Titre</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="taskDescription" rows="4"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Projet</label>
                                <select class="form-control" id="taskProject" required>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Statut</label>
                                <select class="form-control" id="taskStatus">
                                    {% for value, label in status_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Priorit√©</label>
                                <select class="form-control" id="taskPriority">
                                    {% for value, label in priority_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Complexit√©</label>
                                <select class="form-control" id="taskComplexity">
                                    {% for value, label in complexity_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Date d'√©ch√©ance</label>
                                <input type="date" class="form-control" id="taskDueDate" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Progression (%)</label>
                                <input type="number" class="form-control" id="taskProgress" min="0" max="100" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Assign√© √†</label>
                        <select class="form-control" id="taskAssignees" multiple size="5">
                            {% for user in available_users %}
                            <option value="{{ user.id }}">{{ user.get_full_name }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="add-task-btn" style="width: 100%;">Enregistrer</button>
                </form>
            </div>
            
            <!-- Tab Commentaires -->
            <div id="comments-tab" class="tab-pane">
                <div class="form-group">
                    <textarea class="form-control" id="newComment" rows="3" placeholder="Ajouter un commentaire..."></textarea>
                    <button class="add-task-btn" style="margin-top: 10px;" onclick="addComment()">
                        <i class="fas fa-paper-plane"></i> Commenter
                    </button>
                </div>
                
                <div id="comments-list" style="margin-top: 20px;">
                    <!-- Les commentaires seront charg√©s dynamiquement -->
                </div>
            </div>
            
            <!-- Tab Pi√®ces jointes -->
            <div id="attachments-tab" class="tab-pane">
                <form id="attachmentForm" enctype="multipart/form-data" onsubmit="uploadAttachment(event)">
                    <div class="form-group">
                        <input type="file" class="form-control" id="attachmentFile" required>
                    </div>
                    <button type="submit" class="add-task-btn">
                        <i class="fas fa-upload"></i> Uploader
                    </button>
                </form>
                
                <div id="attachments-list" style="margin-top: 20px;">
                    <!-- Les pi√®ces jointes seront charg√©es dynamiquement -->
                </div>
            </div>
            
            <!-- Tab Historique -->
            <div id="history-tab" class="tab-pane">
                <div id="history-list">
                    <!-- L'historique sera charg√© dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script>
    // Variables globales
    let currentTaskId = null;
    let draggedTask = null;
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser Flatpickr pour les dates
        flatpickr("#taskDueDate", {
            locale: "fr",
            dateFormat: "Y-m-d",
            minDate: "today"
        });
        
        // Initialiser le drag & drop
        initializeDragAndDrop();
    });
    
    // Drag & Drop
    function initializeDragAndDrop() {
        const taskLists = document.querySelectorAll('.task-list');
        
        taskLists.forEach(list => {
            list.addEventListener('dragover', dragOver);
            list.addEventListener('drop', drop);
        });
    }
    
    function dragStart(event) {
        draggedTask = event.target.closest('.task-card');
        if (draggedTask) {
            draggedTask.classList.add('dragging');
            event.dataTransfer.setData('text/plain', draggedTask.dataset.taskId);
        }
    }
    
    function dragEnd(event) {
        const task = event.target.closest('.task-card');
        if (task) {
            task.classList.remove('dragging');
        }
        draggedTask = null;
    }
    
    function dragOver(event) {
        event.preventDefault();
    }
    
    function drop(event) {
        event.preventDefault();
        
        const taskList = event.target.closest('.task-list');
        if (!taskList) return;
        
        const taskId = event.dataTransfer.getData('text/plain');
        const newStatus = taskList.dataset.status;
        
        // R√©cup√©rer l'ordre
        const tasks = [...taskList.querySelectorAll('.task-card')];
        const dropIndex = tasks.findIndex(task => {
            const rect = task.getBoundingClientRect();
            return event.clientY < rect.top + rect.height / 2;
        });
        
        // Mettre √† jour le statut via API
        fetch('{% url "taches:update_task_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                task_id: taskId,
                status: newStatus,
                order: dropIndex === -1 ? tasks.length : dropIndex
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recharger la page pour refl√©ter les changements
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la mise √† jour');
        });
    }
    
    // Gestion du modal
    function openTaskModal(taskId, defaultStatus = null) {
        currentTaskId = taskId;
        
        if (taskId) {
            // Charger les d√©tails de la t√¢che
            fetch(`/taches/api/task/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fillTaskForm(data.task);
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                });
        } else {
            // Nouvelle t√¢che
            resetTaskForm();
            if (defaultStatus) {
                document.getElementById('taskStatus').value = defaultStatus;
            }
        }
        
        document.getElementById('taskModal').style.display = 'block';
    }
    
    function closeTaskModal() {
        document.getElementById('taskModal').style.display = 'none';
        currentTaskId = null;
    }
    
    function fillTaskForm(task) {
        document.getElementById('taskId').value = task.id;
        document.getElementById('taskTitle').value = task.title;
        document.getElementById('taskDescription').value = task.description || '';
        document.getElementById('taskProject').value = task.project.id;
        document.getElementById('taskStatus').value = task.status;
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('taskComplexity').value = task.complexity;
        document.getElementById('taskDueDate').value = task.due_date.split('T')[0];
        document.getElementById('taskProgress').value = task.completion_percentage;
        
        // S√©lectionner les assign√©s
        const assignees = document.getElementById('taskAssignees');
        for (let option of assignees.options) {
            option.selected = task.assigned_to.some(u => u.id == option.value);
        }
        
        // Charger les commentaires
        loadComments(task.id);
        
        // Charger les pi√®ces jointes
        loadAttachments(task.id);
    }
    
    function resetTaskForm() {
        document.getElementById('taskId').value = '';
        document.getElementById('taskForm').reset();
        document.getElementById('comments-list').innerHTML = '';
        document.getElementById('attachments-list').innerHTML = '';
    }
    
    function saveTask(event) {
        event.preventDefault();
        
        const taskData = {
            title: document.getElementById('taskTitle').value,
            description: document.getElementById('taskDescription').value,
            project_id: document.getElementById('taskProject').value,
            status: document.getElementById('taskStatus').value,
            priority: document.getElementById('taskPriority').value,
            complexity: document.getElementById('taskComplexity').value,
            due_date: document.getElementById('taskDueDate').value,
            completion_percentage: document.getElementById('taskProgress').value,
            assigned_to: Array.from(document.getElementById('taskAssignees').selectedOptions).map(opt => opt.value)
        };
        
        const url = currentTaskId ? 
            `/taches/api/task/${currentTaskId}/update/` : 
            '/taches/api/task/create/';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeTaskModal();
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
    
    function changeProject(projectId) {
        if (projectId) {
            window.location.href = `/taches/kanban/${projectId}/`;
        } else {
            window.location.href = '/taches/kanban/';
        }
    }
    
    function switchTab(tabName) {
        // Mettre √† jour les tabs
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        
        // Activer le tab s√©lectionn√©
        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    }
    
    function loadComments(taskId) {
        fetch(`/taches/api/task/${taskId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const commentsList = document.getElementById('comments-list');
                    commentsList.innerHTML = '';
                    
                    data.task.comments.forEach(comment => {
                        commentsList.innerHTML += `
                            <div class="comment">
                                <div class="comment-avatar" style="background: hsl(${comment.user.id % 360}, 70%, 60%);">
                                    ${comment.user.initials}
                                </div>
                                <div class="comment-content">
                                    <div class="comment-header">
                                        <span class="comment-author">${comment.user.name}</span>
                                        <span class="comment-date">${comment.created_at_display}</span>
                                    </div>
                                    <div class="comment-text">${comment.comment}</div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
    }
    
    function addComment() {
        const comment = document.getElementById('newComment').value;
        if (!comment.trim()) return;
        
        fetch(`/taches/api/task/${currentTaskId}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ comment: comment })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('newComment').value = '';
                loadComments(currentTaskId);
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
    
    function loadAttachments(taskId) {
        fetch(`/taches/api/task/${taskId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const attachmentsList = document.getElementById('attachments-list');
                    attachmentsList.innerHTML = '';
                    
                    data.task.attachments.forEach(att => {
                        attachmentsList.innerHTML += `
                            <div class="attachment">
                                <div class="attachment-icon">üìé</div>
                                <div class="attachment-info">
                                    <div class="attachment-name">${att.filename}</div>
                                    <div class="attachment-meta">
                                        ${att.file_size_display} ‚Ä¢ par ${att.user}
                                    </div>
                                </div>
                                <a href="${att.file_url}" class="attachment-download" download>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        `;
                    });
                }
            });
    }
    
    function uploadAttachment(event) {
        event.preventDefault();
        
        const fileInput = document.getElementById('attachmentFile');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch(`/taches/api/task/${currentTaskId}/attach/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fileInput.value = '';
                loadAttachments(currentTaskId);
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
    
    // Fermer le modal en cliquant dehors
    window.onclick = function(event) {
        const modal = document.getElementById('taskModal');
        if (event.target == modal) {
            closeTaskModal();
        }
    }
</script>
{% endblock %}